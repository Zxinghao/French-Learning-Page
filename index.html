<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>French Daily Reader ‚Äî Mobile</title>
<style>
  :root{
    --ink:#0f172a; --muted:#475569;
    --border:#dfe7ef; --shadow:0 10px 32px rgba(2,6,23,.16);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
    color:var(--ink); line-height:1.65; background:#f6f9ff; overflow-x:hidden;
    -webkit-tap-highlight-color: transparent;
  }

  /* Calm background canvas */
  #bgCanvas{position:fixed; inset:0; z-index:-2; background:linear-gradient(180deg,#f7fbff,#eef6ff)}

  /* Top bar (safe area aware) */
  .topbar{
    position:sticky; top:0; z-index:10;
    backdrop-filter:saturate(1.05) blur(10px);
    background:rgba(255,255,255,.62); border-bottom:1px solid rgba(226,232,240,.85);
  }
  .topwrap{
    max-width:1100px; margin:0 auto;
    padding:calc(env(safe-area-inset-top) + 8px) 14px 8px;
    display:flex; gap:10px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
  .brand .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg,#2563eb,#16a34a)}

  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .chip, select, .btn{
    border:1px solid var(--border);
    background:rgba(255,255,255,.75);
    color:var(--ink);
    padding:10px 12px; border-radius:14px; font-weight:600; font-size:16px; /* 16px to avoid iOS zoom */
    min-height:44px; display:inline-flex; align-items:center; gap:8px; backdrop-filter: blur(6px);
  }
  select{cursor:pointer}
  .btn{
    cursor:pointer; background:rgba(238,242,255,.9);
    transition:transform .05s ease, opacity .2s ease;
    touch-action: manipulation; /* ensure taps fire immediately on iOS */
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#16a34a); color:white; border:none}

  /* Layout */
  .wrap{max-width:900px; margin:12px auto 70px; padding:0 14px}
  article{
    background:rgba(255,255,255,.78);
    backdrop-filter: blur(10px);
    border:1px solid rgba(231,237,243,.95); border-radius:22px;
    padding:18px 16px; box-shadow:var(--shadow);
    touch-action: pan-y; /* allow vertical scroll but capture horizontal swipes */
  }
  h1.title{margin:.2rem 0 .3rem; font-size:1.25rem}
  .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:.95rem; margin-bottom:6px}
  .tag{border:1px dashed #cbd5e1; padding:3px 10px; border-radius:999px; background:rgba(248,250,252,.9)}
  .content p{margin:.85rem 0}
  .content p strong{font-weight:700}
  details{margin-top:10px; border-top:1px dashed rgba(226,232,240,.9); padding-top:8px}
  summary{cursor:pointer; font-weight:700; outline:none}
  ul{margin:.3rem 0 .5rem 1.05rem}
  .en{display:none; color:#0b3d92}
  .muted{color:var(--muted)}
  .note{font-size:.92rem; color:var(--muted); margin-top:6px}

  /* Pager */
  .pager{
    display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0 6px;
  }
  .pager .index{color:var(--muted); font-weight:700}
  .pager .btn{flex:0 0 auto; min-width:80px; justify-content:center}

  footer{color:var(--muted); text-align:center; margin:14px 0 calc(14px + env(safe-area-inset-bottom)); font-size:.95rem}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.95em; background:rgba(248,250,252,.9); border:1px solid #e2e8f0; padding:2px 6px; border-radius:6px}

  /* Mobile tweaks */
  @media (max-width: 640px){
    .controls{gap:6px}
    .chip{padding:8px 10px; min-height:44px}
    .wrap{padding:0 10px}
    article{padding:16px 14px}
    h1.title{font-size:1.15rem}
  }

  /* Reduce animation if user prefers */
  @media (prefers-reduced-motion: reduce){
    #bgCanvas{display:none}
  }
</style>
</head>
<body>
<canvas id="bgCanvas" aria-hidden="true"></canvas>

<div class="topbar">
  <div class="topwrap">
    <div class="brand"><span class="dot"></span> French Daily Reader</div>
    <div class="controls">
      <label class="chip">Count:
        <select id="countSelect"><option value="2">2</option><option value="3" selected>3</option></select>
      </label>
      <label class="chip">Level:
        <select id="levelSelect">
          <option value="mix" selected>Mix (A2‚ÄìB2)</option>
          <option value="A2">A2</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
        </select>
      </label>
      <label class="chip"><input type="checkbox" id="showEn" /> EN</label>
      <label class="chip"><input type="checkbox" id="slow" /> Slow</label>
      <label class="chip">Voice: <select id="voiceSel"></select></label>
      <button class="btn" id="play" type="button">‚ñ∂Ô∏è Play</button>
      <button class="btn" id="stop" type="button">‚èπ Stop</button>
      <button class="btn primary" id="reroll" type="button">üîÅ Reroll</button>
    </div>
  </div>
</div>

<div class="wrap">
  <article id="card">
    <div class="meta" id="meta"></div>
    <h1 class="title" id="title"></h1>

    <div class="pager">
      <button class="btn" id="prev" type="button">‚Üê Prev</button>
      <div class="index" id="idx">1 / 1</div>
      <button class="btn" id="next" type="button">Next ‚Üí</button>
    </div>

    <div class="content" id="content"></div>

    <details id="vocabBox">
      <summary>Vocabulaire utile</summary>
      <ul id="vocab"></ul>
    </details>

    <details id="grammarBox">
      <summary>Points de grammaire (d√©taill√©s)</summary>
      <ul id="grammar"></ul>
      <div class="note">Astuce : retrouve chaque structure dans le texte, puis lis la phrase √† voix haute.</div>
    </details>

    <p class="muted" id="subtitle"></p>
  </article>

  <footer id="dateInfo">
    Tips: swipe on the card to switch ‚Ä¢ <span class="kbd">Space</span> Play/Pause.
  </footer>
</div>

<script>
/* ===== A) Ultra-calm background optimized for iPhone ===== */
(function(){
  const c = document.getElementById('bgCanvas');
  const ctx = c.getContext('2d', {alpha:true});
  let W=0, H=0, t=0, raf, mobile = /iPhone|Android/i.test(navigator.userAgent);

  const ribbons = (mobile ? [
    {amp: 26, freq: 0.0012, speed: 0.00018, hue: 210, alpha: 0.10},
    {amp: 36, freq: 0.0009, speed: 0.00014, hue: 190, alpha: 0.09}
  ] : [
    {amp: 28, freq: 0.0016, speed: 0.00030, hue: 210, alpha: 0.10},
    {amp: 36, freq: 0.0012, speed: 0.00024, hue: 190, alpha: 0.09},
    {amp: 44, freq: 0.0010, speed: 0.00020, hue: 230, alpha: 0.09}
  ]);

  function sizeToViewport(){
    const dpr = Math.min(window.devicePixelRatio||1, mobile ? 1.5 : 2);
    const vw = window.innerWidth;
    const vh = (window.visualViewport?.height) || window.innerHeight;
    W = c.width  = Math.floor(vw * dpr);
    H = c.height = Math.floor(vh * dpr);
    c.style.width  = vw + 'px';
    c.style.height = vh + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  sizeToViewport();
  window.addEventListener('resize', sizeToViewport, {passive:true});
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', sizeToViewport, {passive:true});
    visualViewport.addEventListener('scroll', sizeToViewport, {passive:true});
  }

  function drawRibbon(r, phase){
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, `hsla(${r.hue}, 80%, 90%, ${r.alpha})`);
    grad.addColorStop(1, `hsla(${(r.hue+40)%360}, 90%, 80%, ${r.alpha})`);
    ctx.fillStyle = grad;

    ctx.beginPath();
    const yBase = H*0.35 + Math.sin(t*r.speed + phase)*18;
    ctx.moveTo(0, yBase);
    const steps = mobile ? 18 : 24;
    for(let i=0;i<=steps;i++){
      const x = (i/steps)*c.clientWidth;
      const y = yBase
        + Math.sin( (x*r.freq) + t*r.speed + phase ) * r.amp
        + Math.cos( (x*r.freq*0.6) - t*r.speed*0.7 + phase*0.7 ) * (r.amp*0.33);
      ctx.lineTo(x, y);
    }
    ctx.lineTo(c.clientWidth, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fill();
  }

  function frame(){
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    t += 1;
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#f7fbff'); g.addColorStop(1, '#eef6ff');
    ctx.fillStyle = g; ctx.fillRect(0,0,c.clientWidth,H);
    ribbons.forEach((r,i)=> drawRibbon(r, i*1.05));
    raf = requestAnimationFrame(frame);
  }
  frame();
})();
</script>

<script>
/* ===== B) Default articles (fallback if JSON isn't found) ===== */
var DEFAULT_ARTICLES = [
  {
    id:"a2_routine_long", level:"A2",
    title:"Ma routine du matin, simple mais efficace",
    title_en:"My morning routine, simple but effective",
    body:[
`Je me l√®ve vers sept heures et demie, parfois un peu plus t√¥t quand j‚Äôai une r√©union importante. Avant d‚Äôallumer mon t√©l√©phone, je bois un grand verre d‚Äôeau pour me r√©veiller doucement. Ensuite, je prends une douche rapide et je m‚Äôhabille avec des v√™tements pr√©par√©s la veille pour gagner du temps. J‚Äôouvre la fen√™tre quelques minutes pour a√©rer la chambre et je fais mon lit. Ces petits gestes me donnent l‚Äôimpression de commencer la journ√©e du bon pied.`,
`Dans la cuisine, je pr√©pare un petit-d√©jeuner simple : un caf√©, un fruit et des tartines avec un peu de beurre et de confiture. Pendant que le caf√© coule, je regarde bri√®vement mes messages et mon agenda. Je note deux ou trois priorit√©s pour la journ√©e afin de rester concentr√©. J‚Äôessaie d‚Äô√©viter les r√©seaux sociaux le matin, parce qu‚Äôils me font perdre du temps sans que je m‚Äôen rende compte.`,
`Quand il fait beau, je vais au travail √† v√©lo : l‚Äôair frais me r√©veille et me met de bonne humeur. S‚Äôil pleut, je prends le bus et j‚Äô√©coute un podcast en fran√ßais pour pratiquer la langue. J‚Äôarrive g√©n√©ralement au bureau vers neuf heures moins le quart. Avant de commencer, je range mon bureau, je ferme les onglets inutiles sur l‚Äôordinateur et je lance une premi√®re t√¢che courte ; cela m‚Äôaide √† me mettre en mouvement sans stress. Gr√¢ce √† cette routine, mes matin√©es sont plus calmes et productives.`
    ],
    body_en:[
`I get up around seven thirty, sometimes a little earlier when I have an important meeting. Before turning on my phone, I drink a big glass of water to wake up gently. Then I take a quick shower and put on clothes prepared the night before to save time. I open the window for a few minutes to air the room and make my bed. These small actions make me feel like I‚Äôm starting the day on the right foot.`,
`In the kitchen, I prepare a simple breakfast: coffee, a piece of fruit, and toast with a bit of butter and jam. While the coffee brews, I briefly check my messages and my calendar. I jot down two or three priorities for the day to stay focused. I try to avoid social media in the morning because it makes me waste time without realizing it.`,
`When the weather is nice, I go to work by bike: the fresh air wakes me up and puts me in a good mood. If it‚Äôs raining, I take the bus and listen to a podcast in French to practice. I usually arrive at the office around quarter to nine. Before starting, I tidy my desk, close unnecessary tabs on the computer, and launch a short first task; that helps me get moving without stress. Thanks to this routine, my mornings are calmer and more productive.`
    ],
    vocab:[["se r√©veiller doucement","to wake up gently"],["a√©rer la chambre","to air the room"],["lancer une t√¢che","to start a task"],["du bon pied","on the right foot"]],
    grammar:[
      {point:"Pr√©sent de l‚Äôhabitude + adverbes d‚Äôordre", fr:"Pr√©sent pour les routines (¬´ je me l√®ve ¬ª, ¬´ je prends ¬ª). Adverbes: ensuite, puis, quand. ¬´ Quand ¬ª peut exprimer une habitude au pr√©sent.", en:"Present for routines; order adverbs; 'quand' can be habitual."},
      {point:"Si + pr√©sent (condition r√©elle)", fr:"Cons√©quence stable: ¬´ S‚Äôil pleut, je prends le bus. ¬ª Pr√©sent dans les deux propositions.", en:"Real condition uses present both sides."},
      {point:"Infinitif pr√©positionnel", fr:"¬´ avant de + inf. ¬ª ant√©riorit√©; ¬´ pour + inf. ¬ª but.", en:"'avant de' (before), 'pour' (purpose)."}
    ]
  }
  /* (You can keep only A2 here; your articles.json will override) */
];

/* ===== C) JSON loader (articles.json) ===== */
let ARTICLES = DEFAULT_ARTICLES;
async function loadArticlesJSON(){
  try{
    const res = await fetch('./articles.json', {cache:'no-store'});
    if(!res.ok) throw 0;
    const json = await res.json();
    if(Array.isArray(json) && json.length) ARTICLES = json;
  }catch(e){
    // keep DEFAULT_ARTICLES
  }
}

/* ===== D) Utilities ===== */
function getParisDateKey(){
  const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit'});
  return fmt.format(new Date());
}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0;}
function byLevel(level){ return level==='mix' ? ARTICLES.slice() : ARTICLES.filter(a=>a.level===level); }
function pickStable(arr, n, seed){
  const rng = mulberry32(seed), idx = arr.map((_,i)=>i);
  for(let i=idx.length-1;i>0;i--){const j=Math.floor(rng()*(i+1)); [idx[i],idx[j]]=[idx[j],idx[i]];}
  return idx.slice(0, Math.min(n, idx.length)).map(i=>arr[i]);
}
function countWords(frParas){ return frParas.join(' ').trim().split(/\s+/).filter(Boolean).length; }
function readTime(words){ const min = Math.max(1, Math.round(words/180)); return min + " min"; }

/* ===== E) DOM ===== */
const titleEl = document.getElementById('title');
const subEl   = document.getElementById('subtitle');
const metaEl  = document.getElementById('meta');
const contentEl = document.getElementById('content');
const vocabEl = document.getElementById('vocab');
const gramEl  = document.getElementById('grammar');
const idxEl   = document.getElementById('idx');
const voiceSel= document.getElementById('voiceSel');
const showEn  = document.getElementById('showEn');
const slow    = document.getElementById('slow');
const levelSelect = document.getElementById('levelSelect');
const countSelect = document.getElementById('countSelect');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const btnPlay = document.getElementById('play');
const btnStop = document.getElementById('stop');
const btnReroll = document.getElementById('reroll');
const dateInfoEl = document.getElementById('dateInfo');
const card = document.getElementById('card');

/* ===== F) State & selection ===== */
let voices = [];
let currentSet = [];
let currentIndex = 0;
let rerollSalt = 0;

function updateDateInfo(){
  const key = getParisDateKey();
  dateInfoEl.innerHTML = 'Today (Europe/Paris): ' + key + ' ‚Ä¢ Swipe on the card to switch';
}
function renderCurrent(){
  const a = currentSet[currentIndex]; if(!a) return;
  const words = countWords(a.body);
  metaEl.innerHTML = `<span class="tag">Level: ${a.level}</span><span class="tag">${words} words ‚Ä¢ ~${readTime(words)}</span>`;
  titleEl.textContent = a.title;
  subEl.innerHTML = a.title_en ? `<em>${a.title_en}</em>` : '';
  contentEl.innerHTML = a.body.map((p,i)=>`<p>${p}</p><p class="en">${a.body_en?.[i]||''}</p>`).join('');
  vocabEl.innerHTML = (a.vocab||[]).map(v=>`<li><strong>${v[0]}</strong> ‚Äî <span class="muted">${v[1]}</span></li>`).join('');
  gramEl.innerHTML  = (a.grammar||[]).map(g=>`<li><strong>${g.point}.</strong> ${g.fr} <span class="muted">(${g.en})</span></li>`).join('');
  idxEl.textContent = `${currentIndex+1} / ${currentSet.length}`;
  document.querySelectorAll('.en').forEach(n=> n.style.display = showEn.checked ? 'block' : 'none');

  // Auto-collapse grammar/vocab on small screens for less clutter
  if (window.innerWidth <= 640) {
    document.getElementById('grammarBox').open = false;
    document.getElementById('vocabBox').open = false;
  }
}
function computeTodaySet(){
  const key = getParisDateKey();
  const lvl = levelSelect.value;
  const n = parseInt(countSelect.value, 10);
  const pool = byLevel(lvl);
  const seed = hashStr(key + '|' + lvl + '|' + n + '|' + rerollSalt);
  currentSet = pickStable(pool, n, seed);
  currentIndex = 0;
  updateDateInfo();
  renderCurrent();
}

/* ===== G) Audio (TTS) ===== */
function loadVoices(){
  const all = window.speechSynthesis.getVoices();
  voices = all.filter(v=> /^fr(-|_|$)/i.test(v.lang) || /French/i.test(v.name));
  if (!voices.length) voices = all.length ? all : [];
  voiceSel.innerHTML = voices.length
    ? voices.map((v,i)=>`<option value="${i}">${v.name} ‚Äî ${v.lang}${/^fr/i.test(v.lang)?'':' (no FR)'}</option>`).join('')
    : `<option value="-1">No voices detected</option>`;
}
window.speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 800);

function speakCurrent(){
  speechSynthesis.cancel();
  const a = currentSet[currentIndex]; if(!a) return;
  const rate = slow.checked ? 0.85 : 1.0;
  const chosen = voices[voiceSel.selectedIndex] || voices[0];
  a.body.forEach(txt=>{
    const u = new SpeechSynthesisUtterance(txt);
    if(chosen) u.voice = chosen;
    u.lang = (chosen && chosen.lang) || 'fr-FR';
    u.rate = rate;
    speechSynthesis.speak(u);
  });
}
function stopSpeech(){ speechSynthesis.cancel(); }
function togglePlay(){
  if(speechSynthesis.speaking && !speechSynthesis.paused){ speechSynthesis.pause(); }
  else if(speechSynthesis.paused){ speechSynthesis.resume(); }
  else { speakCurrent(); }
}

/* ===== H) Events ===== */
showEn.addEventListener('change', ()=> document.querySelectorAll('.en').forEach(n=> n.style.display = showEn.checked ? 'block' : 'none'));
[levelSelect, countSelect].forEach(sel=> sel.addEventListener('change', computeTodaySet));
btnPrev.addEventListener('click', ()=>{ if(currentIndex>0){ currentIndex--; renderCurrent(); } });
btnNext.addEventListener('click', ()=>{ if(currentIndex<currentSet.length-1){ currentIndex++; renderCurrent(); } });
btnReroll.addEventListener('click', ()=>{ rerollSalt++; computeTodaySet(); });
btnPlay.addEventListener('click', togglePlay);
btnStop.addEventListener('click', stopSpeech);
window.addEventListener('keydown', (e)=>{
  const t = (e.target && e.target.tagName || '').toLowerCase();
  if(t==='input'||t==='textarea'||t==='select') return;
  if(e.key==='ArrowLeft'){ e.preventDefault(); btnPrev.click(); }
  if(e.key==='ArrowRight'){ e.preventDefault(); btnNext.click(); }
  if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
});

/* ===== I) Swipe left/right on the card (safe with buttons) ===== */
(function(){
  let x0=null, y0=null, t0=0, startTarget=null;

  function isControl(el){
    return el && el.closest('.btn, button, select, option, summary, details, a, input, textarea, label');
  }

  card.addEventListener('touchstart', (e)=>{
    const t = e.changedTouches[0];
    x0 = t.clientX; y0 = t.clientY; t0 = Date.now();
    startTarget = e.target;
  }, {passive:true});

  card.addEventListener('touchend', (e)=>{
    if (x0==null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - x0;
    const dy = t.clientY - y0;
    const dt = Date.now() - t0;

    // reset for next gesture
    x0 = y0 = null;

    // If the touch began on a control, don't treat it as a swipe
    if (isControl(startTarget)) { startTarget = null; return; }
    startTarget = null;

    // Only treat as swipe if it‚Äôs a quick, mostly-horizontal gesture
    if (Math.abs(dx) > 60 && Math.abs(dy) < 40 && dt < 600){
      if (dx < 0 && currentIndex < currentSet.length-1) { currentIndex++; renderCurrent(); }
      else if (dx > 0 && currentIndex > 0) { currentIndex--; renderCurrent(); }
    }
  }, {passive:true});

  // Extra safety: stop click bubbling from buttons so swipe handler never interferes
  ['prev','next','play','stop','reroll'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', (e)=> e.stopPropagation());
  });
})();

/* ===== J) Init ===== */
(async function init(){
  await loadArticlesJSON();
  loadVoices();
  computeTodaySet();
})();
</script>
</body>
</html>
