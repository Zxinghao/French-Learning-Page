<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>French Daily Reader ‚Äî Mobile/Desktop</title>
<style>
  :root{
    --ink:#0f172a; --muted:#475569;
    --border:#dfe7ef; --shadow:0 10px 32px rgba(2,6,23,.16);
    --disabled:#cbd5e1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
    color:var(--ink); line-height:1.65; background:#f6f9ff; overflow-x:hidden;
    -webkit-tap-highlight-color: transparent;
  }

  /* Calm background canvas */
  #bgCanvas{position:fixed; inset:0; z-index:-2; background:linear-gradient(180deg,#f7fbff,#eef6ff)}

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:10;
    backdrop-filter:saturate(1.05) blur(10px);
    background:rgba(255,255,255,.62); border-bottom:1px solid rgba(226,232,240,.85);
  }
  .topwrap{
    max-width:1100px; margin:0 auto;
    padding:calc(env(safe-area-inset-top) + 8px) 14px 8px;
    display:flex; gap:10px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
  .brand .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg,#2563eb,#16a34a)}

  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .chip, select, .btn{
    border:1px solid var(--border);
    background:rgba(255,255,255,.75);
    color:var(--ink);
    padding:10px 12px; border-radius:14px; font-weight:600; font-size:16px; /* avoid iOS zoom */
    min-height:44px; display:inline-flex; align-items:center; gap:8px; backdrop-filter: blur(6px);
  }
  select{cursor:pointer}
  .btn{
    cursor:pointer; background:rgba(238,242,255,.9);
    transition:transform .05s ease, opacity .2s ease;
    touch-action: manipulation;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#16a34a); color:white; border:none}
  .btn[disabled]{
    opacity:.55; cursor:not-allowed; border-color:var(--disabled); background:rgba(248,250,252,.8); color:var(--muted);
    pointer-events:none;
  }

  /* Layout */
  .wrap{max-width:900px; margin:12px auto 70px; padding:0 14px}
  article{
    background:rgba(255,255,255,.78);
    backdrop-filter: blur(10px);
    border:1px solid rgba(231,237,243,.95); border-radius:22px;
    padding:18px 16px; box-shadow:var(--shadow);
    touch-action: pan-y; /* allow vertical scroll but capture horizontal swipes */
  }
  h1.title{margin:.2rem 0 .3rem; font-size:1.25rem}
  .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:.95rem; margin-bottom:6px}
  .tag{border:1px dashed #cbd5e1; padding:3px 10px; border-radius:999px; background:rgba(248,250,252,.9)}
  .content p{margin:.85rem 0}
  .content p strong{font-weight:700}
  details{margin-top:10px; border-top:1px dashed rgba(226,232,240,.9); padding-top:8px}
  summary{cursor:pointer; font-weight:700; outline:none}
  ul{margin:.3rem 0 .5rem 1.05rem}
  .en{display:none; color:#0b3d92}
  .muted{color:var(--muted)}
  .note{font-size:.92rem; color:var(--muted); margin-top:6px}

  /* Pager */
  .pager{
    display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0 6px;
  }
  .pager .index{color:var(--muted); font-weight:700}
  .pager .btn{flex:0 0 auto; min-width:88px; justify-content:center}

  /* Notices */
  .notice{
    margin:10px 0 0; font-size:.95rem; color:#0b3d92;
    background:rgba(237,244,255,.85); border:1px solid #cfe1ff; padding:8px 10px; border-radius:10px;
  }

  footer{color:var(--muted); text-align:center; margin:14px 0 calc(14px + env(safe-area-inset-bottom)); font-size:.95rem}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.95em; background:rgba(248,250,252,.9); border:1px solid #e2e8f0; padding:2px 6px; border-radius:6px}

  @media (max-width: 640px){
    .controls{gap:6px}
    .chip{padding:8px 10px; min-height:44px}
    .wrap{padding:0 10px}
    article{padding:16px 14px}
    h1.title{font-size:1.15rem}
  }
  @media (prefers-reduced-motion: reduce){ #bgCanvas{display:none} }
</style>
</head>
<body>
<canvas id="bgCanvas" aria-hidden="true"></canvas>

<div class="topbar">
  <div class="topwrap">
    <div class="brand"><span class="dot"></span> French Daily Reader</div>
    <div class="controls">
      <label class="chip">Count:
        <select id="countSelect"><option value="2">2</option><option value="3" selected>3</option></select>
      </label>
      <label class="chip">Level:
        <select id="levelSelect">
          <option value="mix" selected>Mix (A2‚ÄìB2)</option>
          <option value="A2">A2</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
        </select>
      </label>
      <label class="chip"><input type="checkbox" id="showEn" /> EN</label>
      <label class="chip"><input type="checkbox" id="slow" /> Slow</label>
      <label class="chip">Voice: <select id="voiceSel"></select></label>
      <button class="btn" id="play" type="button">‚ñ∂Ô∏è Play</button>
      <button class="btn" id="stop" type="button">‚èπ Stop</button>
      <button class="btn primary" id="reroll" type="button">üîÅ Reroll</button>
    </div>
  </div>
</div>

<div class="wrap">
  <article id="card">
    <div class="meta" id="meta"></div>
    <h1 class="title" id="title"></h1>

    <div class="pager">
      <button class="btn" id="prev" type="button" aria-label="Previous article">‚Üê Prev</button>
      <div class="index" id="idx">1 / 1</div>
      <button class="btn" id="next" type="button" aria-label="Next article">Next ‚Üí</button>
    </div>

    <div class="content" id="content"></div>

    <details id="vocabBox">
      <summary>Vocabulaire utile</summary>
      <ul id="vocab"></ul>
    </details>

    <details id="grammarBox">
      <summary>Points de grammaire (d√©taill√©s)</summary>
      <ul id="grammar"></ul>
      <div class="note">Astuce : retrouve chaque structure dans le texte, puis lis la phrase √† voix haute.</div>
    </details>

    <p class="muted" id="subtitle"></p>
    <div id="notice" class="notice" style="display:none"></div>
  </article>

  <footer id="dateInfo">
    Tips: swipe on the card to switch ‚Ä¢ <span class="kbd">Space</span> Play/Pause.
  </footer>
</div>

<script>
/* ===== A) Calm background (slow aurora ribbons) ===== */
(function(){
  const c = document.getElementById('bgCanvas');
  const ctx = c.getContext('2d', {alpha:true});
  let W=0, H=0, t=0;
  const mobile = /iPhone|Android/i.test(navigator.userAgent);
  const ribbons = (mobile ? [
    {amp: 26, freq: 0.0012, speed: 0.00018, hue: 210, alpha: 0.10},
    {amp: 36, freq: 0.0009, speed: 0.00014, hue: 190, alpha: 0.09}
  ] : [
    {amp: 28, freq: 0.0016, speed: 0.00030, hue: 210, alpha: 0.10},
    {amp: 36, freq: 0.0012, speed: 0.00024, hue: 190, alpha: 0.09},
    {amp: 44, freq: 0.0010, speed: 0.00020, hue: 230, alpha: 0.09}
  ]);
  function sizeToViewport(){
    const dpr = Math.min(window.devicePixelRatio||1, mobile ? 1.5 : 2);
    const vw = window.innerWidth;
    const vh = (window.visualViewport?.height) || window.innerHeight;
    W = c.width  = Math.floor(vw * dpr);
    H = c.height = Math.floor(vh * dpr);
    c.style.width  = vw + 'px';
    c.style.height = vh + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  sizeToViewport();
  window.addEventListener('resize', sizeToViewport, {passive:true});
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', sizeToViewport, {passive:true});
    visualViewport.addEventListener('scroll', sizeToViewport, {passive:true});
  }
  function drawRibbon(r, phase){
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, `hsla(${r.hue}, 80%, 90%, ${r.alpha})`);
    grad.addColorStop(1, `hsla(${(r.hue+40)%360}, 90%, 80%, ${r.alpha})`);
    ctx.fillStyle = grad;
    ctx.beginPath();
    const yBase = H*0.35 + Math.sin(t*r.speed + phase)*18;
    ctx.moveTo(0, yBase);
    const steps = mobile ? 18 : 24;
    for(let i=0;i<=steps;i++){
      const x = (i/steps)*c.clientWidth;
      const y = yBase
        + Math.sin( (x*r.freq) + t*r.speed + phase ) * r.amp
        + Math.cos( (x*r.freq*0.6) - t*r.speed*0.7 + phase*0.7 ) * (r.amp*0.33);
      ctx.lineTo(x, y);
    }
    ctx.lineTo(c.clientWidth, H); ctx.lineTo(0, H); ctx.closePath(); ctx.fill();
  }
  function frame(){
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    t += 1;
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#f7fbff'); g.addColorStop(1, '#eef6ff');
    ctx.fillStyle = g; ctx.fillRect(0,0,c.clientWidth,H);
    ribbons.forEach((r,i)=> drawRibbon(r, i*1.05));
    requestAnimationFrame(frame);
  }
  frame();
})();
</script>

<script>
/* ===== B) Built-in fallback articles (A2/B1/B2, each ‚â•200 words FR) ===== */
var DEFAULT_ARTICLES = [
  {
    id:"a2_routine_long", level:"A2",
    title:"Ma routine du matin, simple mais efficace",
    title_en:"My morning routine, simple but effective",
    body:[
"Je me l√®ve vers sept heures et demie, parfois un peu plus t√¥t quand j‚Äôai une r√©union importante. Avant d‚Äôallumer mon t√©l√©phone, je bois un grand verre d‚Äôeau pour me r√©veiller doucement. Ensuite, je prends une douche rapide et je m‚Äôhabille avec des v√™tements pr√©par√©s la veille pour gagner du temps. J‚Äôouvre la fen√™tre quelques minutes pour a√©rer la chambre et je fais mon lit. Ces petits gestes me donnent l‚Äôimpression de commencer la journ√©e du bon pied.",
"Dans la cuisine, je pr√©pare un petit-d√©jeuner simple : un caf√©, un fruit et des tartines avec un peu de beurre et de confiture. Pendant que le caf√© coule, je regarde bri√®vement mes messages et mon agenda. Je note deux ou trois priorit√©s pour la journ√©e afin de rester concentr√©. J‚Äôessaie d‚Äô√©viter les r√©seaux sociaux le matin, parce qu‚Äôils me font perdre du temps sans que je m‚Äôen rende compte. Quand je dois partir t√¥t, je prends un yaourt et une poign√©e d‚Äôamandes, ce qui est rapide et nourrissant sans √™tre trop lourd.",
"Quand il fait beau, je vais au travail √† v√©lo : l‚Äôair frais me r√©veille et me met de bonne humeur. S‚Äôil pleut, je prends le bus et j‚Äô√©coute un podcast en fran√ßais pour pratiquer la langue. J‚Äôarrive g√©n√©ralement au bureau vers neuf heures moins le quart. Avant de commencer, je range mon bureau, je ferme les onglets inutiles sur l‚Äôordinateur et je lance une premi√®re t√¢che courte ; cela m‚Äôaide √† me mettre en mouvement sans stress. Gr√¢ce √† cette routine, mes matin√©es sont plus calmes, plus pr√©visibles et souvent plus productives, m√™me lorsque la journ√©e devient charg√©e."
    ],
    body_en:[
"I get up around seven thirty, sometimes a little earlier when I have an important meeting. Before turning on my phone, I drink a big glass of water to wake up gently. Then I take a quick shower and put on clothes prepared the night before to save time. I open the window for a few minutes to air the room and make my bed. These small actions make me feel like I‚Äôm starting the day on the right foot.",
"In the kitchen, I prepare a simple breakfast: coffee, a piece of fruit, and toast with a bit of butter and jam. While the coffee brews, I briefly check my messages and my calendar. I jot down two or three priorities for the day to stay focused. I try to avoid social media in the morning because it makes me waste time without realizing it. When I have to leave early, I grab a yogurt and a handful of almonds‚Äîquick, nourishing, and not too heavy.",
"When the weather is nice, I go to work by bike: the fresh air wakes me up and puts me in a good mood. If it‚Äôs raining, I take the bus and listen to a podcast in French to practice. I usually arrive at the office around quarter to nine. Before starting, I tidy my desk, close unnecessary tabs on the computer, and launch a short first task; that helps me get moving without stress. Thanks to this routine, my mornings are calmer, more predictable, and often more productive‚Äîeven when the day gets busy."
    ],
    vocab:[["se r√©veiller doucement","to wake up gently"],["a√©rer la chambre","to air the room"],["lancer une t√¢che","to start a task"],["du bon pied","on the right foot"]],
    grammar:[
      {point:"Pr√©sent de l‚Äôhabitude + adverbes d‚Äôordre", fr:"Pr√©sent pour les routines : ¬´ je me l√®ve ¬ª, ¬´ je prends ¬ª. Marqueurs : d‚Äôabord, ensuite, puis, quand.", en:"Present for routines; order adverbs."},
      {point:"Si + pr√©sent (condition r√©elle)", fr:"¬´ S‚Äôil pleut, je prends le bus. ¬ª Pr√©sent dans les deux propositions pour une cons√©quence g√©n√©rale.", en:"Real condition uses present in both clauses."},
      {point:"Infinitif pr√©positionnel", fr:"¬´ avant de + inf. ¬ª exprime l‚Äôant√©riorit√© ; ¬´ pour + inf. ¬ª exprime le but.", en:"'avant de' (before), 'pour' (purpose)."}
    ]
  },
  {
    id:"b1_project_long", level:"B1",
    title:"Organiser un projet personnel sur un mois",
    title_en:"Organizing a personal project over a month",
    body:[
"Au d√©but, je d√©finis un objectif clair et mesurable. Par exemple : ¬´ terminer une courte histoire de deux mille mots ¬ª ou ¬´ r√©aliser une vid√©o de cinq minutes ¬ª. Ensuite, je d√©coupe l‚Äôobjectif en petites √©tapes concr√®tes : trouver l‚Äôid√©e, faire un plan simple, produire une premi√®re version, relire ou monter, puis publier. Je r√©serve des cr√©neaux fixes trois ou quatre fois par semaine, d‚Äôenviron quarante-cinq minutes, et j‚Äô√©teins les notifications pendant ce temps pour rester concentr√©. Je choisis un endroit calme, je pr√©pare un minuteur, et je note ce que je veux avoir termin√© √† la fin de la s√©ance.",
"Je tiens un carnet de bord o√π je note les obstacles rencontr√©s et les solutions test√©es. Cela m‚Äôaide √† comprendre ce qui fonctionne pour moi. Par exemple, je constate que je travaille mieux le matin, apr√®s un caf√©, et que j‚Äôavance davantage quand je commence par une mini-t√¢che tr√®s facile. Quand je bloque, je r√©duis la difficult√© : je me donne dix minutes pour √©crire sans m‚Äôarr√™ter, ou bien je pr√©pare simplement la structure. Je me fixe aussi des limites : pas plus d‚Äôune heure de recherche d‚Äôinspiration, pour √©viter de me perdre sur Internet. Enfin, je demande un retour √† un ami une fois par semaine, afin d‚Äôavoir un regard ext√©rieur et des suggestions concr√®tes.",
"√Ä la fin de chaque semaine, je fais un bilan rapide : ce que j‚Äôai accompli, ce qui a bloqu√©, ce que je vais essayer ensuite. Si je prends du retard, je r√©duis le p√©rim√®tre au lieu d‚Äôabandonner : une histoire plus courte, une vid√©o plus simple, un prototype plut√¥t qu‚Äôun produit fini. Le but est de terminer quelque chose de pr√©sentable. En un mois, je progresse non seulement sur le contenu, mais aussi sur la m√©thode : j‚Äôapprends √† mieux planifier, √† √©valuer mon temps, √† formuler une demande de feedback utile et √† garder la motivation sans pression excessive."
    ],
    body_en:[
"At the start, I define a clear, measurable goal: ‚Äúfinish a short story of two thousand words‚Äù or ‚Äúmake a five-minute video.‚Äù Then I break it into concrete steps: find the idea, outline, produce a first version, revise or edit, then publish. I block fixed slots three or four times a week for about forty-five minutes and turn off notifications to stay focused. I choose a quiet place, set a timer, and note what I want done by the end of the session.",
"I keep a logbook where I note obstacles and tested solutions. It helps me see what works for me. I notice I work better in the morning after coffee, and I make more progress when I begin with a very easy mini-task. When I‚Äôm stuck, I lower the difficulty: ten minutes of nonstop writing, or just setting the structure. I also set limits: no more than one hour of inspiration research, to avoid getting lost online. Finally, I ask a friend for weekly feedback to get an outside view and concrete suggestions.",
"At the end of each week, I do a quick review: what I accomplished, what blocked me, what I‚Äôll try next. If I fall behind, I reduce the scope instead of quitting: a shorter story, a simpler video, a prototype rather than a finished product. The goal is to finish something presentable. In a month, I progress not only on the content but also on the method: I learn to plan better, estimate my time, ask for useful feedback, and keep motivation without excessive pressure."
    ],
    vocab:[["un carnet de bord","logbook / progress journal"],["un cr√©neau","time slot"],["r√©duire le p√©rim√®tre","reduce scope"]],
    grammar:[
      {point:"Infinitif de but / restriction", fr:"¬´ pour + inf. ¬ª exprime le but ; ¬´ afin de ¬ª est plus formel. ¬´ pour √©viter de + inf. ¬ª marque la restriction.", en:"Purpose with 'pour/afin de'; restriction with 'pour √©viter de'."},
      {point:"Relatives (qui/que/o√π/dont) + accords", fr:"Accord du participe pass√© avec COD ant√©pos√© : ¬´ les solutions que j‚Äôai test√©es ¬ª. ", en:"Relative pronouns; past participle agreement."},
      {point:"Concession (m√™me si / bien que)", fr:"¬´ m√™me si ¬ª + indicatif ; ¬´ bien que ¬ª + subjonctif.", en:"'m√™me si' + indicative; 'bien que' + subjunctive."}
    ]
  },
  {
    id:"b2_media_long", level:"B2",
    title:"Lire l‚Äôactualit√© avec m√©thode et distance critique",
    title_en:"Reading the news methodically and critically",
    body:[
"Face au flux continu d‚Äôinformations, je commence par v√©rifier la nature de la source : m√©dia reconnu, blog personnel, r√©seau social ? Je regarde la date de publication et, si possible, la date des faits. Lorsque le titre est tr√®s alarmant, je lis l‚Äôarticle en entier pour rep√©rer les nuances, les limites de l‚Äô√©tude cit√©e et les √©ventuelles contradictions. Ensuite, je cherche un deuxi√®me article, id√©alement d‚Äôun m√©dia au positionnement √©ditorial diff√©rent, pour comparer les angles. J‚Äôobserve si le vocabulaire est neutre ou charg√©, et si l‚Äôauteur distingue clairement les faits des interpr√©tations.",
"Je pr√™te attention aux chiffres et √† la m√©thodologie : taille de l‚Äô√©chantillon, p√©riode observ√©e, marge d‚Äôerreur. Quand un graphique appara√Æt, je v√©rifie l‚Äô√©chelle, l‚Äôunit√© et l‚Äôaxe utilis√© ; une pr√©sentation trompeuse peut modifier fortement la perception. Je lis aussi les notes de bas de page et les liens cit√©s : ils indiquent si l‚Äôargumentation repose sur des sources solides. Si une citation circule sur les r√©seaux, j‚Äôessaie d‚Äôen retrouver la version compl√®te, car un extrait tr√®s court simplifie souvent √† l‚Äôexc√®s et change le sens.",
"Enfin, je garde une distance √©motionnelle. Si une nouvelle me met en col√®re, j‚Äôattends quelques minutes avant de partager ; puis je reformule ce que j‚Äôai compris avec mes propres mots pour v√©rifier que je ne r√©p√®te pas un slogan. Je me demande : ¬´ Quel est l‚Äôobjectif de cette publication ? Informer, convaincre, vendre ? ¬ª Pour rester √©quilibr√©, j‚Äôajoute √† mon fil des m√©dias internationaux, des m√©dias locaux sp√©cialis√©s et des journalistes que je connais pour leur rigueur. Avec cette m√©thode, je lis moins d‚Äôarticles, mais je les comprends mieux, et je r√©siste davantage aux interpr√©tations rapides et aux titres sensationnalistes."
    ],
    body_en:[
"Faced with a continuous flow of information, I first check the type of source: established outlet, personal blog, social network? I look at the publication date and, if possible, the date of the events. When the headline is very alarming, I read the entire article to spot nuance, limits of any cited study, and possible contradictions. Then I look for a second piece‚Äîideally from a publication with a different editorial stance‚Äîto compare angles. I watch whether the wording is neutral or loaded and whether the author separates facts from interpretations.",
"I pay attention to numbers and methodology: sample size, period, margin of error. When there is a chart, I check the scale, unit, and axes; misleading presentation can strongly alter perception. I also read footnotes and cited links: they show whether the argument relies on solid sources. If a quote circulates on social media, I try to find the full version, because short snippets often oversimplify and change the meaning.",
"Finally, I keep emotional distance. If news makes me angry, I wait a few minutes before sharing; then I restate what I understood in my own words to make sure I‚Äôm not repeating a slogan. I ask: ‚ÄúWhat is the goal of this publication‚Äîinform, persuade, sell?‚Äù To stay balanced, I add international outlets, specialized local media, and journalists I trust for rigor. With this method, I read fewer pieces but understand them better, and I resist snap interpretations and sensational headlines."
    ],
    vocab:[["positionnement √©ditorial","editorial stance"],["√©chantillon","sample (statistics)"],["titre sensationnaliste","sensational headline"]],
    grammar:[
      {point:"Impersonnels de probabilit√©", fr:"¬´ Il est probable que‚Ä¶ ¬ª / ¬´ Il est possible que‚Ä¶ ¬ª (souvent + subjonctif en registre soutenu).", en:"Probability expressions; often subjunctive in formal register."},
      {point:"Subordonn√©es circonstancielles", fr:"Temps (¬´ lorsque ¬ª), but (¬´ pour ¬ª), opposition (¬´ bien que ¬ª + subj.).", en:"Temporal, purpose, concession."},
      {point:"Nominalisations", fr:"¬´ publication ¬ª, ¬´ interpr√©tation ¬ª, ¬´ m√©thodologie ¬ª structurent l‚Äôargumentation.", en:"Nominalizations help structure."}
    ]
  }
];
</script>

<script>
/* ===== C) JSON loader (articles.json) with validation & notices ===== */
let ARTICLES = DEFAULT_ARTICLES;

/* ===== Word-count policy ===== */
const MIN_WORDS = 200;

/* Notice helper */
function showNotice(msg){
  const n = document.getElementById('notice');
  if (!n) return;
  n.style.display = 'block';
  n.textContent = msg;
}

/* Normalizer accepts common alias keys and pads translations */
function normalizeArticle(a){
  const body = Array.isArray(a.body) ? a.body
             : Array.isArray(a.content) ? a.content
             : (typeof a.body === 'string' ? [a.body] : []);

  const body_en = Array.isArray(a.body_en) ? a.body_en
                : Array.isArray(a.translation) ? a.translation
                : [];

  const vocab = Array.isArray(a.vocab) ? a.vocab
               : Array.isArray(a.vocabulary) ? a.vocabulary
               : [];

  const grammar = Array.isArray(a.grammar) ? a.grammar
                 : Array.isArray(a.grammar_points) ? a.grammar_points
                 : [];

  // pad/trim body_en to match body length
  const be = body_en.slice(0, body.length);
  while (be.length < body.length) be.push('');

  return {
    id: a.id || cryptoRandomId(),
    level: (a.level || '').toUpperCase(),
    title: a.title || '',
    title_en: a.title_en || a.subtitle_en || '',
    body, body_en: be,
    vocab, grammar
  };
}
function isValidArticle(a){
  if (!a.title || !Array.isArray(a.body) || a.body.length === 0) return false;
  if (!['A2','B1','B2'].includes(a.level)) return false;
  if (countWords(a.body) < MIN_WORDS) return false;  // enforce ‚â•200 FR words
  return true;
}
function cryptoRandomId(){
  try { return 'id_' + crypto.getRandomValues(new Uint32Array(1))[0].toString(36); }
  catch(e){ return 'id_' + Math.random().toString(36).slice(2); }
}

async function loadArticlesJSON(){
  try{
    // Daily cache-bust (Paris) so iPhone Safari picks up changes
    const dailyKey = new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
    const res = await fetch('./articles.json?v='+encodeURIComponent(dailyKey), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw = await res.json();
    if(!Array.isArray(raw) || raw.length===0) throw new Error('JSON is empty or not an array.');

    const normalized = raw.map(normalizeArticle);
    const valid = normalized.filter(isValidArticle);
    const skipped = normalized.length - valid.length;

    if (valid.length > 0) {
      ARTICLES = valid;
      if (skipped > 0) showNotice(`${skipped} article(s) < ${MIN_WORDS} mots ou invalides ont √©t√© ignor√©s.`);
    } else {
      showNotice(`Tous les √©l√©ments de articles.json ont √©t√© ignor√©s (niveau/format/longueur). Utilisation des articles int√©gr√©s.`);
    }
  }catch(err){
    showNotice(`Impossible de charger articles.json (${err.message || 'erreur'}). Utilisation des articles int√©gr√©s.`);
  }
}
</script>

<script>
/* ===== D) Utilities ===== */
function getParisDateKey(){
  const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit'});
  return fmt.format(new Date());
}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0;}
function countWords(frParas){ return (frParas||[]).join(' ').trim().split(/\s+/).filter(Boolean).length; }
function readTime(words){ const min = Math.max(1, Math.round(words/180)); return min + " min"; }

/* Build a pool that respects the ‚â•200-word policy, topping up from defaults if needed */
function buildLongPool(level, desired){
  let pool = (level==='mix' ? ARTICLES.slice() : ARTICLES.filter(a=>a.level===level))
    .filter(a => countWords(a.body) >= MIN_WORDS);

  if (pool.length < desired){
    const fallback = (level==='mix' ? DEFAULT_ARTICLES.slice() : DEFAULT_ARTICLES.filter(a=>a.level===level))
      .filter(a => countWords(a.body) >= MIN_WORDS && !pool.find(p=>p.id===a.id));
    if (fallback.length) showNotice(`Des articles trop courts ont √©t√© ignor√©s (<${MIN_WORDS} mots). Remplacement par des articles de secours.`);
    pool = pool.concat(fallback);
  }
  return pool;
}

function byLevel(level){ return level==='mix' ? ARTICLES.slice() : ARTICLES.filter(a=>a.level===level); }
function pickStable(arr, n, seed){
  const rng = mulberry32(seed), idx = arr.map((_,i)=>i);
  for(let i=idx.length-1;i>0;i--){const j=Math.floor(rng()*(i+1)); [idx[i],idx[j]]=[idx[j],idx[i]];}
  return idx.slice(0, Math.min(n, idx.length)).map(i=>arr[i]);
}
</script>

<script>
/* ===== E) DOM refs ===== */
const titleEl = document.getElementById('title');
const subEl   = document.getElementById('subtitle');
const metaEl  = document.getElementById('meta');
const contentEl = document.getElementById('content');
const vocabEl = document.getElementById('vocab');
const gramEl  = document.getElementById('grammar');
const idxEl   = document.getElementById('idx');
const voiceSel= document.getElementById('voiceSel');
const showEn  = document.getElementById('showEn');
const slow    = document.getElementById('slow');
const levelSelect = document.getElementById('levelSelect');
const countSelect = document.getElementById('countSelect');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const btnPlay = document.getElementById('play');
const btnStop = document.getElementById('stop');
const btnReroll = document.getElementById('reroll');
const dateInfoEl = document.getElementById('dateInfo');
const card = document.getElementById('card');
const notice = document.getElementById('notice');

/* ===== F) State ===== */
let voices = [];
let currentSet = [];
let currentIndex = 0;
let rerollSalt = 0;
</script>

<script>
/* ===== G) Nav helpers ===== */
function updateNav(){
  const n = currentSet.length;
  idxEl.textContent = `${Math.min(currentIndex+1,n)} / ${n||1}`;
  btnPrev.disabled = !(n>1 && currentIndex>0);
  btnNext.disabled = !(n>1 && currentIndex<n-1);

  if (n <= 1){
    let reason = 'Only one article available.';
    const lvl = levelSelect.value;
    const pool = byLevel(lvl);
    if (pool.length <= 1) reason = `Seulement ${pool.length} article trouv√© pour ¬´ ${lvl} ¬ª. Ajoutez-en dans articles.json ou passez sur ‚ÄúMix‚Äù.`;
    notice.style.display = 'block';
    notice.textContent = reason;
  } else {
    notice.style.display = 'none';
    notice.textContent = '';
  }
}

/* ===== H) Render & selection ===== */
function renderCurrent(){
  const a = currentSet[currentIndex]; if(!a){ contentEl.innerHTML=''; updateNav(); return; }
  const words = countWords(a.body);
  metaEl.innerHTML = `<span class="tag">Level: ${a.level||'‚Äî'}</span><span class="tag">${words} words ‚Ä¢ ~${readTime(words)}</span>`;
  titleEl.textContent = a.title||'';
  subEl.innerHTML = a.title_en ? `<em>${a.title_en}</em>` : '';
  contentEl.innerHTML = (a.body||[]).map((p,i)=>`<p>${p}</p><p class="en">${a.body_en?.[i]||''}</p>`).join('');
  vocabEl.innerHTML = (a.vocab||[]).map(v=>`<li><strong>${v[0]}</strong> ‚Äî <span class="muted">${v[1]}</span></li>`).join('');
  gramEl.innerHTML  = (a.grammar||[]).map(g=>`<li><strong>${g.point}.</strong> ${g.fr} <span class="muted">(${g.en})</span></li>`).join('');
  document.querySelectorAll('.en').forEach(n=> n.style.display = showEn.checked ? 'block' : 'none');

  // Auto-collapse on small screens
  if (window.innerWidth <= 640) {
    document.getElementById('grammarBox').open = false;
    document.getElementById('vocabBox').open = false;
  }
  updateNav();
}
function updateDateInfo(){
  const key = getParisDateKey();
  dateInfoEl.innerHTML = 'Today (Europe/Paris): ' + key + ' ‚Ä¢ Swipe on the card to switch';
}
function computeTodaySet(){
  const key = getParisDateKey();
  const lvl = levelSelect.value;
  const n = parseInt(countSelect.value, 10);

  const pool = buildLongPool(lvl, n);
  const seed = hashStr(key + '|' + lvl + '|' + n + '|' + rerollSalt);

  if (pool.length === 0){
    showNotice(`Aucun article ‚â• ${MIN_WORDS} mots pour ¬´ ${lvl} ¬ª. Utilisation d‚Äôexemples int√©gr√©s.`);
    currentSet = pickStable(DEFAULT_ARTICLES.filter(a => (lvl==='mix'||a.level===lvl) && countWords(a.body)>=MIN_WORDS), n, seed);
  } else {
    currentSet = pickStable(pool, n, seed);
  }

  currentIndex = 0;
  updateDateInfo();
  renderCurrent();
}
</script>

<script>
/* ===== I) Audio (TTS) ===== */
function loadVoices(){
  const all = window.speechSynthesis.getVoices();
  voices = all.filter(v=> /^fr(-|_|$)/i.test(v.lang) || /French/i.test(v.name));
  if (!voices.length) voices = all.length ? all : [];
  voiceSel.innerHTML = voices.length
    ? voices.map((v,i)=>`<option value="${i}">${v.name} ‚Äî ${v.lang}${/^fr/i.test(v.lang)?'':' (no FR)'}</option>`).join('')
    : `<option value="-1">No voices detected</option>`;
}
window.speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 800);

function speakCurrent(){
  speechSynthesis.cancel();
  const a = currentSet[currentIndex]; if(!a) return;
  const rate = slow.checked ? 0.85 : 1.0;
  const chosen = voices[voiceSel.selectedIndex] || voices[0];
  (a.body||[]).forEach(txt=>{
    const u = new SpeechSynthesisUtterance(txt);
    if(chosen) u.voice = chosen;
    u.lang = (chosen && chosen.lang) || 'fr-FR';
    u.rate = rate;
    speechSynthesis.speak(u);
  });
}
function stopSpeech(){ speechSynthesis.cancel(); }
function togglePlay(){
  if(speechSynthesis.speaking && !speechSynthesis.paused){ speechSynthesis.pause(); }
  else if(speechSynthesis.paused){ speechSynthesis.resume(); }
  else { speakCurrent(); }
}
</script>

<script>
/* ===== J) Events ===== */
showEn.addEventListener('change', ()=> document.querySelectorAll('.en').forEach(n=> n.style.display = showEn.checked ? 'block' : 'none'));
[levelSelect, countSelect].forEach(sel=> sel.addEventListener('change', computeTodaySet));
btnPrev.addEventListener('click', ()=>{ if(currentIndex>0){ currentIndex--; renderCurrent(); } });
btnNext.addEventListener('click', ()=>{ if(currentIndex<currentSet.length-1){ currentIndex++; renderCurrent(); } });
btnReroll.addEventListener('click', ()=>{ rerollSalt++; computeTodaySet(); });
btnPlay.addEventListener('click', togglePlay);
btnStop.addEventListener('click', stopSpeech);
window.addEventListener('keydown', (e)=>{
  const t = (e.target && e.target.tagName || '').toLowerCase();
  if(t==='input'||t==='textarea'||t==='select') return;
  if(e.key==='ArrowLeft'){ e.preventDefault(); btnPrev.click(); }
  if(e.key==='ArrowRight'){ e.preventDefault(); btnNext.click(); }
  if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
});

/* Swipe left/right on the card (ignores controls) */
(function(){
  let x0=null, y0=null, t0=0, startTarget=null;
  function isControl(el){ return el && el.closest('.btn, button, select, option, summary, details, a, input, textarea, label'); }
  card.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; x0=t.clientX; y0=t.clientY; t0=Date.now(); startTarget=e.target; }, {passive:true});
  card.addEventListener('touchend', (e)=>{
    if (x0==null) return;
    const t=e.changedTouches[0]; const dx=t.clientX-x0; const dy=t.clientY-y0; const dt=Date.now()-t0;
    x0=y0=null; if (isControl(startTarget)) { startTarget=null; return; } startTarget=null;
    if (Math.abs(dx)>60 && Math.abs(dy)<40 && dt<600){
      if (dx<0 && currentIndex<currentSet.length-1){ currentIndex++; renderCurrent(); }
      else if (dx>0 && currentIndex>0){ currentIndex--; renderCurrent(); }
    }
  }, {passive:true});
  ['prev','next','play','stop','reroll'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('click', (e)=> e.stopPropagation());
  });
})();

/* ===== K) Init ===== */
(async function init(){
  await loadArticlesJSON();
  loadVoices();
  computeTodaySet();
})();
</script>
</body>
</html>
