<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>French Daily Reader ‚Äî Calm Dynamic Background</title>
<style>
  :root{ --ink:#0f172a; --muted:#475569; --border:#dfe7ef; --shadow:0 12px 40px rgba(2,6,23,.16); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
    color:var(--ink); line-height:1.7; background:#f6f9ff; overflow-x:hidden;
  }

  /* CALM background canvas */
  #bgCanvas{position:fixed; inset:0; z-index:-2; background:linear-gradient(180deg,#f7fbff,#eef6ff)}

  /* Top bar */
  .topbar{
    position:fixed; top:0; left:0; right:0; z-index:10;
    backdrop-filter:saturate(1.1) blur(10px);
    background:rgba(255,255,255,.55); border-bottom:1px solid rgba(226,232,240,.8);
  }
  .topwrap{
    max-width:1100px; margin:0 auto; padding:10px 14px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
  .brand .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg,#2563eb,#16a34a)}
  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .chip, select, .btn{
    border:1px solid var(--border); background:rgba(255,255,255,.7); color:var(--ink);
    padding:8px 12px; border-radius:12px; font-weight:600; font-size:.95rem; backdrop-filter: blur(6px);
  }
  select{cursor:pointer}
  .btn{cursor:pointer; background:rgba(238,242,255,.85); transition:transform .05s ease, opacity .2s ease}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(90deg,#2563eb,#16a34a); color:white; border:none}

  /* Reading card */
  .wrap{max-width:880px; margin:120px auto 80px; padding:0 16px}
  article{
    background:rgba(255,255,255,.72);
    backdrop-filter: blur(10px);
    border:1px solid rgba(231,237,243,.9); border-radius:22px;
    padding:24px 22px 18px; box-shadow:var(--shadow);
  }
  h1.title{margin:.2rem 0 .4rem; font-size:1.38rem}
  .meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:.95rem; margin-bottom:8px}
  .tag{border:1px dashed #cbd5e1; padding:2px 10px; border-radius:999px; background:rgba(248,250,252,.85)}
  .content p{margin:.9rem 0}
  .content p strong{font-weight:700}
  details{margin-top:14px; border-top:1px dashed rgba(226,232,240,.9); padding-top:10px}
  summary{cursor:pointer; font-weight:700}
  ul{margin:.35rem 0 .6rem 1.1rem}
  .en{display:none; color:#0b3d92}
  .muted{color:var(--muted)}
  .note{font-size:.92rem; color:var(--muted); margin-top:6px}

  /* Pager */
  .pager{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:14px 0 10px;}
  .pager .index{color:var(--muted); font-weight:700}

  footer{color:var(--muted); text-align:center; margin:24px 0 22px; font-size:.9rem}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9em; background:rgba(248,250,252,.85); border:1px solid #e2e8f0; padding:1px 6px; border-radius:6px}
</style>
</head>
<body>
<canvas id="bgCanvas" aria-hidden="true"></canvas>

<div class="topbar">
  <div class="topwrap">
    <div class="brand"><span class="dot"></span> French Daily Reader</div>
    <div class="controls">
      <label class="chip">Count:
        <select id="countSelect"><option value="2">2</option><option value="3" selected>3</option></select>
      </label>
      <label class="chip">Level:
        <select id="levelSelect">
          <option value="mix" selected>Mix (A2‚ÄìB2)</option>
          <option value="A2">A2</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
        </select>
      </label>
      <label class="chip"><input type="checkbox" id="showEn" /> EN</label>
      <label class="chip"><input type="checkbox" id="slow" /> Slow</label>
      <label class="chip">Voice: <select id="voiceSel"></select></label>
      <button class="btn" id="play">‚ñ∂Ô∏è Play</button>
      <button class="btn" id="stop">‚èπ Stop</button>
      <button class="btn primary" id="reroll">üîÅ Reroll</button>
    </div>
  </div>
</div>

<div class="wrap">
  <article id="card">
    <div class="meta" id="meta"></div>
    <h1 class="title" id="title"></h1>

    <div class="pager">
      <button class="btn" id="prev">‚Üê Prev</button>
      <div class="index" id="idx">1 / 1</div>
      <button class="btn" id="next">Next ‚Üí</button>
    </div>

    <div class="content" id="content"></div>

    <details>
      <summary>Vocabulaire utile</summary>
      <ul id="vocab"></ul>
    </details>

    <details open>
      <summary>Points de grammaire (d√©taill√©s)</summary>
      <ul id="grammar"></ul>
      <div class="note">Astuce : retrouve chaque structure dans le texte, puis lis la phrase √† voix haute.</div>
    </details>

    <p class="muted" id="subtitle"></p>
  </article>

  <footer id="dateInfo">
    Shortcuts: <span class="kbd">‚Üê/‚Üí</span> switch articles, <span class="kbd">Space</span> Play/Pause.
  </footer>
</div>

<script>
/* ===== (A) Calm dynamic background: slow aurora ribbons ===== */
(function(){
  const c = document.getElementById('bgCanvas');
  const ctx = c.getContext('2d', {alpha:true});
  let W=0, H=0, t=0, raf;
  const ribbons = [
    {amp: 28,  freq: 0.0016, speed: 0.00035, hue: 210, alpha: 0.10},
    {amp: 36,  freq: 0.0012, speed: 0.00028, hue: 190, alpha: 0.10},
    {amp: 44,  freq: 0.0010, speed: 0.00022, hue: 230, alpha: 0.10},
    {amp: 58,  freq: 0.0008, speed: 0.00018, hue: 170, alpha: 0.08}
  ];
  function resize(){
    const dpr = Math.min(window.devicePixelRatio||1, 2);
    W = c.width  = Math.floor(window.innerWidth * dpr);
    H = c.height = Math.floor(window.innerHeight * dpr);
    c.style.width  = window.innerWidth + 'px';
    c.style.height = window.innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  function drawRibbon({amp,freq,speed,hue,alpha}, phase){
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, `hsla(${hue}, 80%, 90%, ${alpha})`);
    grad.addColorStop(1, `hsla(${(hue+40)%360}, 90%, 80%, ${alpha})`);
    ctx.fillStyle = grad;

    ctx.beginPath();
    const yBase = H*0.35 + Math.sin(t*speed + phase)*20;
    ctx.moveTo(0, yBase);
    const steps = 24; // fewer points = smoother, lighter
    for(let i=0;i<=steps;i++){
      const x = (i/steps)*window.innerWidth;
      const y = yBase
        + Math.sin( (x*freq) + t*speed + phase ) * amp
        + Math.cos( (x*freq*0.6) - t*speed*0.7 + phase*0.7 ) * (amp*0.35);
      ctx.lineTo(x, y);
    }
    ctx.lineTo(window.innerWidth, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fill();
  }

  function step(){
    t += 1; // time in frames; actual speeds are tiny above
    // soft base
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#f7fbff'); g.addColorStop(1, '#eef6ff');
    ctx.fillStyle = g; ctx.fillRect(0,0,window.innerWidth,H);

    // draw ribbons (back to front)
    ribbons.forEach((r, i)=> drawRibbon(r, i*1.1));

    raf = requestAnimationFrame(step);
  }
  step();
  document.addEventListener('visibilitychange', ()=> {
    if(document.hidden){ cancelAnimationFrame(raf); }
    else { raf = requestAnimationFrame(step); }
  });
})();

/* ===== (B) Articles (A2‚ÜíB2, ‚â•200 words each) ===== */
var ARTICLES = [
  {
    id:"a2_routine_long", level:"A2",
    title:"Ma routine du matin, simple mais efficace",
    title_en:"My morning routine, simple but effective",
    body:[
`Je me l√®ve vers sept heures et demie, parfois un peu plus t√¥t quand j‚Äôai une r√©union importante. Avant d‚Äôallumer mon t√©l√©phone, je bois un grand verre d‚Äôeau pour me r√©veiller doucement. Ensuite, je prends une douche rapide et je m‚Äôhabille avec des v√™tements pr√©par√©s la veille pour gagner du temps. J‚Äôouvre la fen√™tre quelques minutes pour a√©rer la chambre et je fais mon lit. Ces petits gestes me donnent l‚Äôimpression de commencer la journ√©e du bon pied.`,
`Dans la cuisine, je pr√©pare un petit-d√©jeuner simple : un caf√©, un fruit et des tartines avec un peu de beurre et de confiture. Pendant que le caf√© coule, je regarde bri√®vement mes messages et mon agenda. Je note deux ou trois priorit√©s pour la journ√©e afin de rester concentr√©. J‚Äôessaie d‚Äô√©viter les r√©seaux sociaux le matin, parce qu‚Äôils me font perdre du temps sans que je m‚Äôen rende compte.`,
`Quand il fait beau, je vais au travail √† v√©lo : l‚Äôair frais me r√©veille et me met de bonne humeur. S‚Äôil pleut, je prends le bus et j‚Äô√©coute un podcast en fran√ßais pour pratiquer la langue. J‚Äôarrive g√©n√©ralement au bureau vers neuf heures moins le quart. Avant de commencer, je range mon bureau, je ferme les onglets inutiles sur l‚Äôordinateur et je lance une premi√®re t√¢che courte ; cela m‚Äôaide √† me mettre en mouvement sans stress. Gr√¢ce √† cette routine, mes matin√©es sont plus calmes et productives.`
    ],
    body_en:[
`I get up around seven thirty, sometimes a little earlier when I have an important meeting. Before turning on my phone, I drink a big glass of water to wake up gently. Then I take a quick shower and put on clothes prepared the night before to save time. I open the window for a few minutes to air the room and make my bed. These small actions make me feel like I‚Äôm starting the day on the right foot.`,
`In the kitchen, I prepare a simple breakfast: coffee, a piece of fruit, and toast with a bit of butter and jam. While the coffee brews, I briefly check my messages and my calendar. I jot down two or three priorities for the day to stay focused. I try to avoid social media in the morning because it makes me waste time without realizing it.`,
`When the weather is nice, I go to work by bike: the fresh air wakes me up and puts me in a good mood. If it‚Äôs raining, I take the bus and listen to a podcast in French to practice. I usually arrive at the office around quarter to nine. Before starting, I tidy my desk, close unnecessary tabs on the computer, and launch a short first task; that helps me get moving without stress. Thanks to this routine, my mornings are calmer and more productive.`
    ],
    vocab:[["se r√©veiller doucement","to wake up gently"],["a√©rer la chambre","to air the room"],["lancer une t√¢che","to start a task"],["du bon pied","on the right foot"]],
    grammar:[
      {point:"Pr√©sent de l‚Äôhabitude + adverbes d‚Äôordre", fr:"Pr√©sent pour les routines (¬´ je me l√®ve ¬ª, ¬´ je prends ¬ª). Adverbes: ensuite, puis, quand. ¬´ Quand ¬ª peut exprimer une habitude au pr√©sent.", en:"Present for routines; order adverbs; 'quand' can be habitual."},
      {point:"Si + pr√©sent (condition r√©elle)", fr:"Cons√©quence stable: ¬´ S‚Äôil pleut, je prends le bus. ¬ª Pr√©sent dans les deux propositions. Inversion possible sans changement de sens.", en:"Real condition uses present; word order flexible."},
      {point:"Infinitif pr√©positionnel", fr:"¬´ avant de + inf. ¬ª ant√©riorit√©; ¬´ pour + inf. ¬ª but. Ex.: ¬´ avant d‚Äôallumer ¬ª, ¬´ pour gagner du temps ¬ª. ", en:"'avant de' = before; 'pour' = purpose."}
    ]
  },
  {
    id:"b1_project_long", level:"B1",
    title:"Organiser un projet personnel sur un mois",
    title_en:"Organizing a personal project over a month",
    body:[
`Au d√©but, je d√©finis un objectif clair et mesurable. Par exemple : ¬´ terminer une courte histoire de deux mille mots ¬ª ou ¬´ r√©aliser une vid√©o de cinq minutes ¬ª. Ensuite, je d√©coupe l‚Äôobjectif en petites √©tapes concr√®tes : trouver l‚Äôid√©e, faire un plan simple, produire une premi√®re version, relire ou monter, puis publier. Je r√©serve des cr√©neaux fixes trois ou quatre fois par semaine, d‚Äôenviron quarante-cinq minutes, et j‚Äô√©teins les notifications pendant ce temps pour rester concentr√©.`,
`Je tiens un carnet de bord o√π je note les obstacles rencontr√©s et les solutions test√©es. Cela m‚Äôaide √† comprendre ce qui fonctionne pour moi. Par exemple, je constate que je travaille mieux le matin, apr√®s un caf√©, et que j‚Äôavance davantage quand je commence par une mini-t√¢che tr√®s facile. Je me fixe aussi des limites : pas plus d‚Äôune heure de recherche d‚Äôinspiration, pour √©viter de me perdre sur Internet. Enfin, je demande un retour √† un ami une fois par semaine, afin d‚Äôavoir un regard ext√©rieur et des suggestions concr√®tes.`,
`√Ä la fin de chaque semaine, je fais un bilan rapide : ce que j‚Äôai accompli, ce qui a bloqu√©, ce que je vais essayer ensuite. Si je prends du retard, je r√©duis le p√©rim√®tre au lieu d‚Äôabandonner : une histoire plus courte, une vid√©o plus simple. Le but est de terminer quelque chose de pr√©sentable. En un mois, je progresse non seulement sur le contenu, mais aussi sur la m√©thode : j‚Äôapprends √† mieux planifier, √† √©valuer mon temps et √† garder la motivation sans pression excessive.`
    ],
    body_en:[
`At the start, I define a clear, measurable goal: ‚Äúfinish a short story of two thousand words‚Äù or ‚Äúmake a five-minute video.‚Äù Then I break it into concrete steps: find the idea, outline, produce a first version, revise or edit, then publish. I block fixed slots three or four times a week for about forty-five minutes and turn off notifications to stay focused.`,
`I keep a logbook where I note obstacles and tested solutions. It helps me see what works for me. For example, I notice I work better in the morning after coffee, and I make more progress when I begin with a very easy mini-task. I also set limits: no more than one hour of inspiration research, to avoid getting lost online. Finally, I ask a friend for feedback once a week to get an outside view and concrete suggestions.`,
`At the end of each week, I do a quick review: what I accomplished, what blocked me, what I‚Äôll try next. If I fall behind, I reduce scope instead of giving up: a shorter story, a simpler video. The aim is to finish something presentable. In a month, I progress not only on the content but also on the method: I learn to plan better, estimate my time, and keep motivation without excessive pressure.`
    ],
    vocab:[["un carnet de bord","logbook / progress journal"],["un cr√©neau","time slot"],["r√©duire le p√©rim√®tre","reduce scope"]],
    grammar:[
      {point:"Infinitif de but / restriction", fr:"¬´ pour + inf. ¬ª exprime le but. ¬´ afin de ¬ª: registre plus formel. ¬´ pour √©viter de + inf. ¬ª marque la restriction.", en:"Purpose with 'pour/afin de'; restriction with 'pour √©viter de'."},
      {point:"Relatives (qui/que/o√π/dont) + accords", fr:"¬´ ce que j‚Äôai accompli ¬ª, ¬´ les solutions que j‚Äôai test√©es ¬ª. Rappel : avec ¬´ que ¬ª COD plac√© avant, accord du participe pass√© (¬´ test√©es ¬ª).", en:"Relative pronouns; past participle agreement with preceding COD."},
      {point:"Concession (m√™me si / bien que)", fr:"¬´ m√™me si ¬ª + indicatif ; ¬´ bien que ¬ª + subjonctif : nuance plus soutenue.", en:"'m√™me si' + indicative; 'bien que' + subjunctive."}
    ]
  },
  {
    id:"b2_media_long", level:"B2",
    title:"Lire l‚Äôactualit√© avec m√©thode et distance critique",
    title_en:"Reading the news methodically and critically",
    body:[
`Face au flux continu d‚Äôinformations, je commence par v√©rifier la nature de la source : m√©dia reconnu, blog personnel, r√©seau social ? Je regarde la date de publication et, si possible, la date des faits. Lorsque le titre est tr√®s alarmant, je lis l‚Äôarticle en entier pour rep√©rer les nuances, les limites de l‚Äô√©tude cit√©e et les √©ventuelles contradictions. Ensuite, je cherche un deuxi√®me article, id√©alement d‚Äôun m√©dia au positionnement √©ditorial diff√©rent, pour comparer les angles.`,
`Je pr√™te attention au vocabulaire : mots √©valuatifs (¬´ catastrophique ¬ª, ¬´ honteux ¬ª) ou formulations prudentes (¬´ il est probable que ¬ª, ¬´ les donn√©es sugg√®rent que ¬ª). Les chiffres demandent toujours du contexte : l‚Äô√©chantillon, la p√©riode, la m√©thodologie. Lorsqu‚Äôun graphique est pr√©sent√©, je v√©rifie l‚Äôaxe, l‚Äôunit√© et l‚Äô√©chelle. Si une citation circule sur les r√©seaux, j‚Äôessaie d‚Äôen retrouver la source compl√®te, car les extraits tr√®s courts simplifient souvent √† l‚Äôexc√®s.`,
`Enfin, je garde une distance √©motionnelle : si une nouvelle me met en col√®re, j‚Äôattends quelques minutes avant de partager. Je me demande : ¬´ Quel est l‚Äôobjectif de cette publication ? Informer, convaincre, vendre ? ¬ª Pour rester √©quilibr√©, j‚Äôajoute √† mon fil des m√©dias internationaux et des m√©dias locaux sp√©cialis√©s. Avec cette m√©thode, je lis moins d‚Äôarticles, mais je les comprends mieux, et je r√©siste davantage aux interpr√©tations rapides et aux titres sensationnalistes.`
    ],
    body_en:[
`Faced with a continuous flow of information, I first check the type of source: established outlet, personal blog, social network? I look at the publication date and, if possible, the date of the events. When the headline is very alarming, I read the entire article to spot nuance, limits of any cited study, and possible contradictions. Then I look for a second article‚Äîideally from a publication with a different editorial stance‚Äîto compare angles.`,
`I pay attention to wording: evaluative terms (‚Äúcatastrophic,‚Äù ‚Äúshameful‚Äù) vs. cautious formulations (‚Äúit is likely that,‚Äù ‚Äúthe data suggest that‚Äù). Numbers always need context: sample, period, methodology. If a chart is shown, I check the axis, unit, and scale. If a quote circulates on social media, I try to find the full source, because short snippets often oversimplify.`,
`Finally, I keep emotional distance: if news makes me angry, I wait a few minutes before sharing. I ask myself: ‚ÄúWhat is the goal of this publication? Inform, persuade, sell?‚Äù To stay balanced, I add both international outlets and specialized local media to my feed. With this method, I read fewer pieces but understand them better, and I resist snap interpretations and sensational headlines.`
    ],
    vocab:[["positionnement √©ditorial","editorial stance"],["√©chantillon","sample (statistics)"],["titre sensationnaliste","sensational headline"]],
    grammar:[
      {point:"Impersonnels de probabilit√©", fr:"¬´ Il est probable que‚Ä¶ ¬ª (ind./subj. selon registre). ¬´ Il est possible que‚Ä¶ ¬ª prend souvent le subjonctif (¬´ ce soit ¬ª).", en:"Indicative vs. subjunctive varies with certainty/register."},
      {point:"Subordonn√©es circonstancielles", fr:"Temps (¬´ lorsque ¬ª), but (¬´ pour ¬ª), opposition (¬´ bien que ¬ª + subj.).", en:"Temporal, purpose, concession; subjunctive after 'bien que'."},
      {point:"Nominalisations", fr:"¬´ publication ¬ª, ¬´ interpr√©tation ¬ª, ¬´ m√©thodologie ¬ª : utiles pour condenser une id√©e et structurer l‚Äôargumentation.", en:"Nominalizations help concision and structure."}
    ]
  }
];

/* ===== (C) Utilities & selection ===== */
function getParisDateKey(){
  var fmt = new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit'});
  return fmt.format(new Date());
}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function hashStr(s){var h=2166136261>>>0; for(var i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0;}
function byLevel(level){ return level==='mix' ? ARTICLES.slice() : ARTICLES.filter(function(a){return a.level===level;}); }
function pickStable(arr, n, seed){
  var rng = mulberry32(seed), idx = arr.map(function(_,i){return i;});
  for(var i=idx.length-1;i>0;i--){var j=Math.floor(rng()*(i+1)); var t=idx[i]; idx[i]=idx[j]; idx[j]=t;}
  return idx.slice(0, Math.min(n, idx.length)).map(function(i){return arr[i];});
}
function countWords(frParas){ return frParas.join(' ').trim().split(/\s+/).filter(Boolean).length; }
function readTime(words){ var min = Math.max(1, Math.round(words/180)); return min + " min"; }

/* ===== (D) DOM & state ===== */
var titleEl = document.getElementById('title');
var subEl   = document.getElementById('subtitle');
var metaEl  = document.getElementById('meta');
var contentEl = document.getElementById('content');
var vocabEl = document.getElementById('vocab');
var gramEl  = document.getElementById('grammar');
var idxEl   = document.getElementById('idx');
var voiceSel= document.getElementById('voiceSel');
var showEn  = document.getElementById('showEn');
var slow    = document.getElementById('slow');
var levelSelect = document.getElementById('levelSelect');
var countSelect = document.getElementById('countSelect');
var btnPrev = document.getElementById('prev');
var btnNext = document.getElementById('next');
var btnPlay = document.getElementById('play');
var btnStop = document.getElementById('stop');
var btnReroll = document.getElementById('reroll');
var dateInfoEl = document.getElementById('dateInfo');

var voices = [];
var currentSet = [];
var currentIndex = 0;
var rerollSalt = 0;

/* ===== (E) Render & selection ===== */
function updateDateInfo(){
  var key = getParisDateKey();
  dateInfoEl.innerHTML = 'Today (Europe/Paris): ' + key + ' ‚Ä¢ <span class="muted">Use ‚Üê/‚Üí to navigate</span>';
}
function renderCurrent(){
  var a = currentSet[currentIndex]; if(!a) return;
  var words = countWords(a.body);
  metaEl.innerHTML = '<span class="tag">Level: ' + a.level + '</span>' +
                     '<span class="tag">' + words + ' words ‚Ä¢ ~' + readTime(words) + '</span>';
  titleEl.textContent = a.title;
  subEl.innerHTML = '<em>' + a.title_en + '</em>';
  contentEl.innerHTML = a.body.map(function(p,i){
    return '<p>' + p + '</p><p class="en">' + (a.body_en[i]||'') + '</p>';
  }).join('');
  vocabEl.innerHTML = a.vocab.map(function(v){ return '<li><strong>' + v[0] + '</strong> ‚Äî <span class="muted">' + v[1] + '</span></li>'; }).join('');
  gramEl.innerHTML  = a.grammar.map(function(g){ return '<li><strong>' + g.point + '.</strong> ' + g.fr + ' <span class="muted">(' + g.en + ')</span></li>'; }).join('');
  idxEl.textContent = (currentIndex+1) + ' / ' + currentSet.length;
  Array.prototype.forEach.call(document.querySelectorAll('.en'), function(n){ n.style.display = showEn.checked ? 'block' : 'none'; });
}
function computeTodaySet(){
  var key = getParisDateKey();
  var lvl = levelSelect.value;
  var n = parseInt(countSelect.value, 10);
  var pool = byLevel(lvl);
  var seed = hashStr(key + '|' + lvl + '|' + n + '|' + rerollSalt);
  currentSet = pickStable(pool, n, seed);
  currentIndex = 0;
  updateDateInfo();
  renderCurrent();
}

/* ===== (F) Audio (TTS) ===== */
function loadVoices(){
  var all = window.speechSynthesis.getVoices();
  voices = all.filter(function(v){ return /^fr(-|_|$)/i.test(v.lang) || /French/i.test(v.name); });
  if (voices.length === 0) { voices = all.length ? all : []; }
  voiceSel.innerHTML = voices.length
    ? voices.map(function(v,i){ return '<option value="'+i+'">'+v.name+' ‚Äî '+v.lang + ( /^fr/i.test(v.lang)? '' : ' (no FR)' ) +'</option>'; }).join('')
    : '<option value="-1">No voices detected</option>';
}
window.speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 800);

function speakCurrent(){
  window.speechSynthesis.cancel();
  var a = currentSet[currentIndex]; if(!a) return;
  var rate = slow.checked ? 0.85 : 1.0;
  var chosen = voices[voiceSel.selectedIndex] || voices[0];
  a.body.forEach(function(txt){
    var u = new SpeechSynthesisUtterance(txt);
    if(chosen) u.voice = chosen;
    u.lang = (chosen && chosen.lang) || 'fr-FR';
    u.rate = rate;
    window.speechSynthesis.speak(u);
  });
}
function stopSpeech(){ window.speechSynthesis.cancel(); }
function togglePlay(){
  if(window.speechSynthesis.speaking && !window.speechSynthesis.paused){ window.speechSynthesis.pause(); }
  else if(window.speechSynthesis.paused){ window.speechSynthesis.resume(); }
  else { speakCurrent(); }
}

/* ===== (G) Events ===== */
showEn.addEventListener('change', function(){
  Array.prototype.forEach.call(document.querySelectorAll('.en'), function(n){ n.style.display = showEn.checked ? 'block' : 'none'; });
});
[levelSelect, countSelect].forEach(function(sel){
  sel.addEventListener('change', computeTodaySet);
});
btnPrev.addEventListener('click', function(){ if(currentIndex>0){ currentIndex--; renderCurrent(); } });
btnNext.addEventListener('click', function(){ if(currentIndex<currentSet.length-1){ currentIndex++; renderCurrent(); } });
btnReroll.addEventListener('click', function(){ rerollSalt++; computeTodaySet(); });
btnPlay.addEventListener('click', togglePlay);
btnStop.addEventListener('click', stopSpeech);
window.addEventListener('keydown', function(e){
  var tag = (e.target && e.target.tagName || '').toLowerCase();
  if(tag==='input' || tag==='textarea' || tag==='select') return;
  if(e.key==='ArrowLeft'){ e.preventDefault(); btnPrev.click(); }
  if(e.key==='ArrowRight'){ e.preventDefault(); btnNext.click(); }
  if(e.code==='Space'){ e.preventDefault(); togglePlay(); }
});

/* ===== (H) Init ===== */
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', function(){ loadVoices(); computeTodaySet(); });
}else{ loadVoices(); computeTodaySet(); }
</script>
</body>
</html>
